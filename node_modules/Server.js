var express		= require("express");
var bodyParser	= require("body-parser");

db = require("db.js");

app = express();

function REST() {
	var self = this;
	self.connectDB();
};

REST.prototype.connectDB = function() {
	var self = this;
	db.connect(function()
		{
			self.configureExpress();
		});
}

REST.prototype.configureExpress = function() {
	var self = this;
	app.use(bodyParser.urlencoded({ extended: true }));
	app.use(bodyParser.json());
	self.initRoutes();
	self.startServer();
}

REST.prototype.initRoutes = function() {
	var router = express.Router();
	app.use('/api', router);

//	router.use(function(req, res, next)
//		{
//			db.connect(function()
//				{
//console.log('EVERY TIME CONNECT')
//					next();
//				});
//		});

	router.get("/",function(req, res) {
		var home = require('../controllers/home.js');
		ctrl = new home(req, res);
	});

	// get all users
	router.get("/users", function(req, res) {
		var user = require('../controllers/user.js');
		ctrl = new user(req, res);//, connection);
		ctrl.list();
	});

	router.get("/users/:user_id",function(req, res) {
		var user = require('../controllers/user.js');
		ctrl = new user(req, res);
		ctrl.retrieve();
	});

	 router.post("/users",function(req, res) {
		var user = require('../controllers/user.js');
		ctrl = new user(req, res);
		ctrl.create();
	});

	router.put("/users",function(req, res) {
		var user = require('../controllers/user.js');
		ctrl = new user(req, res);
		ctrl.update();
	});

	router.delete("/users/:user_id",function(req, res) {
		var user = require('../controllers/user.js');
		ctrl = new user(req, res);
		ctrl.remove();
	});	
}

REST.prototype.startServer = function() {
	app.listen(3000,function(){
		console.log("All right ! I am alive at Port 3000.");
	});
}

REST.prototype.stop = function(err) {
	console.log("ISSUE WITH MYSQL \n" + err);
	process.exit(1);
}

new REST();