var express		= require("express");
//var mysql		= require("mysql");
var bodyParser	= require("body-parser");
//var md5			= require('md5');
//var rest		= require("./REST.js");

db = require("db.js");

app = express();

function REST() {
	var self = this;
//	self.connectMysql();
	self.configureExpress();
};

//REST.prototype.connectMysql = function() {
//	var self = this;
//	db.connect(function()
//		{
//			self.configureExpress();
//		});
//	var pool = mysql.createPool({
//		connectionLimit	: 100,
//		host			: 'localhost',
//		user			: 'root',
//		password		: '',
//		database		: 'restful_api_demo',
//		debug			: false
//	});
//	pool.getConnection(function(err, connection) {
//		if(err) {
//			self.stop(err);
//		} else {
//			self.configureExpress(connection);
//		}
//	});
//}

REST.prototype.configureExpress = function() {//connection) {
	var self = this;
	app.use(bodyParser.urlencoded({ extended: true }));
	app.use(bodyParser.json());
//	var router = express.Router();
//	app.use('/api', router);
//	var rest_router = new rest(router, connection);
	//new rest(connection);
	self.initRoutes();//connection);
	self.startServer();
}

REST.prototype.initRoutes = function() {//connection) {
	var router = express.Router();
	app.use('/api', router);

	router.use(function(req, res, next)
		{
			db.connect(function()
				{
console.log('EVERY TIME CONNECT')
					next();
				});
		});

	router.get("/",function(req, res) {
//		ctrl = require('../controllers/home.js');
//		ctrl.controller(req, res);
		var home = require('../controllers/home.js');
		ctrl = new home(req, res);//, connection);
	});

	// get all users
	router.get("/users", function(req, res) {
//		ctrl = require('../controllers/users.js');
//		ctrl.list(req, res, connection);
console.log('/USERS LIST ROUTE')
		var user = require('../controllers/user.js');
		ctrl = new user(req, res);//, connection);
		ctrl.list();
	});

	router.get("/users/:user_id",function(req, res) {
//		ctrl = require('../controllers/users.js');
//		ctrl.retrieve(req, res, connection);
console.log('/USERS RETRIEVE ROUTE')
		var user = require('../controllers/user.js');
		ctrl = new user(req, res);//, connection);
		ctrl.retrieve();
	});

	 router.post("/users",function(req, res) {
//		ctrl = require('../controllers/users.js');
//		ctrl.insert(req, res, connection);
console.log('/USERS INSERT ROUTE')
		var user = require('../controllers/user.js');
		ctrl = new user(req, res);
		ctrl.create();
	});

	router.put("/users",function(req, res) {
//		ctrl = require('../controllers/users.js');
//		ctrl.update(req, res, connection);
console.log('/USERS UPDATE ROUTE')
		var user = require('../controllers/user.js');
		ctrl = new user(req, res);
		ctrl.update();
	});

	router.delete("/users/:email",function(req, res) {
//		ctrl = require('../controllers/users.js');
//		ctrl.delete(req, res, connection);
console.log('/USERS DELETE ROUTE')
		var user = require('../controllers/user.js');
		ctrl = new user(req, res);
		ctrl.delete();
	});	
}

REST.prototype.startServer = function() {
	app.listen(3000,function(){
		console.log("All right ! I am alive at Port 3000.");
	});
}

REST.prototype.stop = function(err) {
	console.log("ISSUE WITH MYSQL \n" + err);
	process.exit(1);
}

new REST();