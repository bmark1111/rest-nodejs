var mysql	= require("mysql");
var db_connection = false;

var db = {
	'table':	false,
	'qry_str':	false,
	'params':	Array(),
	'connect':	function(callback) {
					var pool = mysql.createPool({
						connectionLimit	: 100,
						host			: 'localhost',
						user			: 'root',
						password		: '',
						database		: 'restful_api_demo',
			//			user			: 'budget',
			//			password		: 'budget',
			//			database		: 'bdm_budget',
						debug			: false
					});
					pool.getConnection(function(err, connection) {
						if(err) {
							db_connection = false;
						} else {
							db_connection = connection;
							callback();
						}
					});
				},
	'select':	function()
				{
					this.qry_str = "SELECT * FROM ?? ";
					this.params = Array(this.table);
				},
	'insert':	function(params)
				{
					this.qry_str = "INSERT INTO ?? (";
					this.params = Array(this.table);
					// attach the params to the query
					var multi = false;
					for(var key in params)
					{
						if (multi)
						{
							this.qry_str += ',';
						}
						this.qry_str += '??';
						this.params.push(key);
						multi = true;
					}
					this.qry_str += ") VALUES (";
					// now attach the values to the query
					var multi = false;
					for(var key in params)
					{
						if (multi)
						{
							this.qry_str += ',';
						}
						this.qry_str += '?';
						this.params.push(params[key]);
						multi = true;
					}
					this.qry_str += ")";
				},
	'update':	function(params)
				{
					this.qry_str = "UPDATE ?? SET ";
					this.params = Array(this.table);
					// now attach the set params to query
					var multi = false;
					for(var key in params)
					{
						if (multi)
						{
							this.qry_str += ',';
						}
						this.qry_str += '?? = ?';
						this.params.push(key);
						this.params.push(params[key]);
						multi = true;
					}
				},
	'remove':	function() {
					this.qry_str = "UPDATE ?? SET ?? = ?";
					this.params = Array(this.table);
					this.params.push('is_deleted');
					this.params.push(1);
				},
	'where':	function(params)
				{
					if (this.qry_str.indexOf('WHERE') == -1) {
						this.qry_str += ' WHERE ';
					} else {
						this.qry_str += ' AND ';
					}
					for (var key in params) {
						this.qry_str += " ?? = ? ";
						this.params.push(key);
						this.params.push(params[key]);
					};
				},
	'query':	function(callback, errCallback) {
					var query = mysql.format(this.qry_str, this.params);
					db_connection.query(query, function(err, rows) {
						if(err) {
							errCallback(err);
						} else {
							callback(rows);
						}
					});
				}
};

module.exports = db;
