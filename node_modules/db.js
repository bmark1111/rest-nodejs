var mysql	= require("mysql");
var db_connection = false;

var db = {
	'table':	false,
	'query':	false,
	'params':	Array(),
	'connect':	function(callback) {
					var pool = mysql.createPool({
						connectionLimit	: 100,
						host			: 'localhost',
						user			: 'root',
						password		: '',
						database		: 'restful_api_demo',
			//			user			: 'budget',
			//			password		: 'budget',
			//			database		: 'bdm_budget',
						debug			: false
					});
					pool.getConnection(function(err, connection) {
						if(err) {
							db_connection = false;
						} else {
							db_connection = connection;
							callback();
						}
					});
				},
	'select':	function()
				{
					this.query = "SELECT * FROM ?? ";
					this.params = Array(this.table);
				},
	'insert':	function(params)
				{
					this.query = "INSERT INTO ?? (";
					this.params = Array(this.table);
					// attach the params to the query
					var multi = false;
					for(var key in params)
					{
						if (multi)
						{
							this.query += ',';
						}
						this.query += '??';
						this.params.push(key);
						multi = true;
					}
					this.query += ") VALUES (";
					// now attach the values to the query
					var multi = false;
					for(var key in params)
					{
						if (multi)
						{
							this.query += ',';
						}
						this.query += '?';
						this.params.push(params[key]);
						multi = true;
					}
					this.query += ")";
				},
	'update':	function()
				{
					this.query = "UPDATE ?? ";
					this.params = Array(this.table);
				},
	'where':	function(params)
				{
					if (typeof(this.params[1]) == 'undefined') {
						this.query += 'WHERE';
					}
					for (var key in params) {
						this.query += " ?? = ? ";
						this.params.push(key);
						this.params.push(params[key]);
					};
				},
//	'get':		function (id, callback, errCallback) {
//					var query = "SELECT * FROM ??";
//					if (id)
//					{
//						query += " WHERE ??=?";
//						var table = [this.table, "user_id", id];
//					} else {
//						var table = [this.table];
//					}
//					query = mysql.format(query, table);
	'get':		function (callback, errCallback) {
console.log(this.query);
console.log(this.params);
					var query = mysql.format(this.query, this.params);
console.log(query);
return;
					db_connection.query(query, function(err, rows) {
						if(err) {
							errCallback(err);
						} else {
							callback(rows);
						}
					});
				},
//	'create':	function(body, callback, errCallback) {
//					var query = "INSERT INTO ??(??,??) VALUES (?,?)";
//					var table = [this.table, "user_email", "user_password", body.user_email, body.user_password];
//					query = mysql.format(query, table);
	'create':	function(callback, errCallback) {
console.log(this.query);
console.log(this.params);
					var query = mysql.format(this.query, this.params);
console.log(query);
return;
					db_connection.query(query, function(err, rows) {
						if(err) {
							errCallback(err);
						} else {
							callback(rows);
						}
					});
				}, 
	'update':	function(body, callback, errCallback) {
					var query = "UPDATE ?? SET ?? = ? WHERE ?? = ?";
					var table = [this.table, "user_password", body.user_password, "user_email", body.user_email];
					query = mysql.format(query, table);
					db_connection.query(query, function(err, rows) {
						if(err) {
							errCallback(err);
						} else {
							callback(rows);
						}
					});
				}, 
	'remove':	function(id, callback, errCallback) {
					var query = "DELETE from ?? WHERE ??=?";
					var table = [this.table, "user_id", id];
					query = mysql.format(query, table);
					db_connection.query(query, function(err, rows) {
						if(err) {
							errCallback(err);
						} else {
							callback(rows);
						}
					});
				}, 
	'run':		function(callback, errCallback) {
					callback(null, this.returnData || {})
				}
};

module.exports = db;
